# coding=utf-8

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib
from pylab import *
import datetime as dt
from WindPy import *
import xlrd
from xlwt import Workbook, easyxf
from xlutils.copy import copy
w.start()


fund_setupdate = w.wss("510010.SH,510020.SH,510030.SH,510050.SH,510060.SH,510070.SH,510090.SH,510110.SH,510120.SH,510130.SH,510150.SH,510160.SH,510170.SH,510180.SH,510190.SH,510210.SH,510220.SH,510230.SH,510260.SH,510270.SH,510280.SH,510290.SH,510300.SH,510310.SH,510330.SH,510360.SH,510410.SH,510420.SH,510430.SH,510440.SH,510500.SH,510510.SH,510520.SH,510560.SH,510580.SH,510630.SH,510650.SH,510660.SH,510680.SH,510710.SH,510810.SH,510880.SH,510900.SH,511010.SH,511210.SH,511220.SH,511230.SH,511600.SH,511650.SH,511660.SH,511680.SH,511690.SH,511700.SH,511760.SH,511770.SH,511800.SH,511810.SH,511820.SH,511830.SH,511850.SH,511860.SH,511880.SH,511890.SH,511900.SH,511910.SH,511920.SH,511930.SH,511950.SH,511960.SH,511970.SH,511980.SH,511990.SH,512000.SH,512010.SH,512070.SH,512100.SH,512120.SH,512210.SH,512220.SH,512230.SH,512300.SH,512310.SH,512330.SH,512340.SH,512500.SH,512510.SH,512580.SH,512600.SH,512610.SH,512640.SH,512660.SH,512680.SH,512810.SH,512880.SH,512900.SH,512990.SH,513030.SH,513050.SH,513100.SH,513500.SH,513600.SH,513660.SH,518800.SH,518880.SH,159001.SZ,159003.SZ,159005.SZ,159901.SZ,159902.SZ,159903.SZ,159905.SZ,159906.SZ,159907.SZ,159908.SZ,159909.SZ,159910.SZ,159911.SZ,159912.SZ,159913.SZ,159915.SZ,159916.SZ,159918.SZ,159919.SZ,159920.SZ,159921.SZ,159922.SZ,159923.SZ,159924.SZ,159925.SZ,159926.SZ,159927.SZ,159928.SZ,159929.SZ,159930.SZ,159931.SZ,159932.SZ,159933.SZ,159934.SZ,159935.SZ,159936.SZ,159937.SZ,159938.SZ,159939.SZ,159940.SZ,159941.SZ,159942.SZ,159943.SZ,159944.SZ,159945.SZ,159946.SZ,159948.SZ,159949.SZ", "fund_setupdate")

fund_fullname = w.wss("510010.SH,510020.SH,510030.SH,510050.SH,510060.SH,510070.SH,510090.SH,510110.SH,510120.SH,510130.SH,510150.SH,510160.SH,510170.SH,510180.SH,510190.SH,510210.SH,510220.SH,510230.SH,510260.SH,510270.SH,510280.SH,510290.SH,510300.SH,510310.SH,510330.SH,510360.SH,510410.SH,510420.SH,510430.SH,510440.SH,510500.SH,510510.SH,510520.SH,510560.SH,510580.SH,510630.SH,510650.SH,510660.SH,510680.SH,510710.SH,510810.SH,510880.SH,510900.SH,511010.SH,511210.SH,511220.SH,511230.SH,511600.SH,511650.SH,511660.SH,511680.SH,511690.SH,511700.SH,511760.SH,511770.SH,511800.SH,511810.SH,511820.SH,511830.SH,511850.SH,511860.SH,511880.SH,511890.SH,511900.SH,511910.SH,511920.SH,511930.SH,511950.SH,511960.SH,511970.SH,511980.SH,511990.SH,512000.SH,512010.SH,512070.SH,512100.SH,512120.SH,512210.SH,512220.SH,512230.SH,512300.SH,512310.SH,512330.SH,512340.SH,512500.SH,512510.SH,512580.SH,512600.SH,512610.SH,512640.SH,512660.SH,512680.SH,512810.SH,512880.SH,512900.SH,512990.SH,513030.SH,513050.SH,513100.SH,513500.SH,513600.SH,513660.SH,518800.SH,518880.SH,159001.SZ,159003.SZ,159005.SZ,159901.SZ,159902.SZ,159903.SZ,159905.SZ,159906.SZ,159907.SZ,159908.SZ,159909.SZ,159910.SZ,159911.SZ,159912.SZ,159913.SZ,159915.SZ,159916.SZ,159918.SZ,159919.SZ,159920.SZ,159921.SZ,159922.SZ,159923.SZ,159924.SZ,159925.SZ,159926.SZ,159927.SZ,159928.SZ,159929.SZ,159930.SZ,159931.SZ,159932.SZ,159933.SZ,159934.SZ,159935.SZ,159936.SZ,159937.SZ,159938.SZ,159939.SZ,159940.SZ,159941.SZ,159942.SZ,159943.SZ,159944.SZ,159945.SZ,159946.SZ,159948.SZ,159949.SZ", "fund_fullname")
fund_setupdate = pd.Series(fund_setupdate.Data[0], index=fund_setupdate.Codes)
fund_fullname = pd.Series(fund_fullname.Data[0], index=fund_fullname.Codes)
fund_fullname.to_csv("ETF_fullname.csv")

def Skewness_ETF_Premium(code, setupdate, enddate):
    data = w.wsd(code,'close, Nav', setupdate, enddate)
    data = pd.DataFrame(np.array(data.Data).T, columns=data.Fields, index=data.Times).dropna()
    data = data[data.apply(lambda x: 0.3<=(x["CLOSE"]/x["NAV"])<=3, axis=1)]
    premium = data["CLOSE"]/data["NAV"]
    skewness = premium.skew()
    return skewness

def Plot_ETF_Premium(code, setupdate_list, enddate):
    setupdate = str(setupdate_list[code])[:10]
    data = w.wsd(code,'close, Nav', setupdate, enddate)
    data = pd.DataFrame(np.array(data.Data).T, columns=data.Fields, index=data.Times).dropna()
    data = data[data.apply(lambda x: 0.3<=(x["CLOSE"]/x["NAV"])<=3, axis=1)]
    data.to_csv("test.csv")
    premium = data["CLOSE"]/data["NAV"]
    premium.plot()
    plt.show()

enddate = "2017-03-07"
skew_list = []
for i in range(len(fund_setupdate)):
    temp_code = fund_setupdate.index[i]
    temp_setupdate = str(fund_setupdate[i])[:10]
    skew_list.append(Skewness_ETF_Premium(temp_code, temp_setupdate, enddate))

skew_series = pd.Series(skew_list, index=fund_setupdate.index)
print skew_series.mean()
len(skew_series[skew_series<0])
plt.show()

skew_series["513500.SH"]

Plot_ETF_Premium("510330.SH", fund_setupdate, enddate)

7> 1 > 2
